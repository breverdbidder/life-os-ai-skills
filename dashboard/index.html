<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life OS - Shapira Family Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --purple: #8b5cf6; --blue: #3b82f6; --green: #10b981; --orange: #f59e0b; --red: #ef4444; --whatsapp: #25D366; }
        body { background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 50%, #0f172a 100%); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; }
        .glass { background: rgba(30, 30, 50, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(139, 92, 246, 0.2); }
        .glow { box-shadow: 0 0 25px rgba(139, 92, 246, 0.3); }
        .glow-green { box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
        .glow-blue { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
        .glow-whatsapp { box-shadow: 0 0 20px rgba(37, 211, 102, 0.4); }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        .driving-animation { animation: drive 3s ease-in-out infinite; }
        @keyframes drive { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(10px); } }
        .whatsapp-btn { background: #25D366; transition: all 0.3s; }
        .whatsapp-btn:hover { background: #128C7E; transform: scale(1.05); }
        .share-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; }
        .share-modal.active { display: flex; }
    </style>
</head>
<body class="text-gray-100">
    <!-- WhatsApp Share Modal -->
    <div id="share-modal" class="share-modal items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 max-w-lg w-full glow-whatsapp">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">üì±</span> Share via WhatsApp
                </h3>
                <button onclick="closeShareModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="space-y-3 mb-6">
                <button onclick="shareUpdate('trip')" class="w-full whatsapp-btn text-white rounded-xl p-4 flex items-center gap-3">
                    <span class="text-2xl">üöó</span>
                    <div class="text-left">
                        <div class="font-semibold">Share Trip Update</div>
                        <div class="text-sm opacity-80">Current location & ETA</div>
                    </div>
                </button>
                
                <button onclick="shareUpdate('swim')" class="w-full whatsapp-btn text-white rounded-xl p-4 flex items-center gap-3">
                    <span class="text-2xl">üèä</span>
                    <div class="text-left">
                        <div class="font-semibold">Share Swim Meet Info</div>
                        <div class="text-sm opacity-80">Michael's events & schedule</div>
                    </div>
                </button>
                
                <button onclick="shareUpdate('hotel')" class="w-full whatsapp-btn text-white rounded-xl p-4 flex items-center gap-3">
                    <span class="text-2xl">üè®</span>
                    <div class="text-left">
                        <div class="font-semibold">Share Hotel Info</div>
                        <div class="text-sm opacity-80">Reservation details</div>
                    </div>
                </button>
                
                <button onclick="shareUpdate('full')" class="w-full whatsapp-btn text-white rounded-xl p-4 flex items-center gap-3">
                    <span class="text-2xl">üìã</span>
                    <div class="text-left">
                        <div class="font-semibold">Share Full Status</div>
                        <div class="text-sm opacity-80">Complete daily summary</div>
                    </div>
                </button>
            </div>
            
            <div class="border-t border-gray-700 pt-4">
                <label class="text-sm text-gray-400 mb-2 block">Send to specific contact:</label>
                <div class="flex gap-2">
                    <input type="tel" id="phone-number" placeholder="+1 (555) 123-4567" 
                           class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white placeholder-gray-500">
                    <button onclick="shareToNumber()" class="whatsapp-btn text-white px-4 py-2 rounded-lg font-semibold">
                        Send
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Or use buttons above to open WhatsApp directly</p>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header with Share Button -->
        <div class="glass rounded-2xl p-5 mb-6 glow">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-5xl">üè†</div>
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-purple-400 to-blue-400 bg-clip-text text-transparent">
                            Life OS - Shapira Family
                        </h1>
                        <p class="text-gray-400 text-sm mt-1">Real-Time Life Tracking ‚Ä¢ ADHD-Optimized</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="openShareModal()" class="whatsapp-btn text-white px-4 py-2 rounded-xl flex items-center gap-2 font-semibold glow-whatsapp">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                        Share
                    </button>
                    <div class="text-right">
                        <div id="current-date" class="text-lg font-semibold text-purple-400"></div>
                        <div id="current-time" class="text-2xl font-mono text-white"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Trip Banner with Quick Share -->
        <div id="trip-banner" class="glass rounded-xl p-4 mb-6 border-l-4 border-blue-500 glow-blue hidden">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <div class="text-4xl driving-animation">üöó</div>
                    <div>
                        <div class="text-lg font-semibold text-blue-400" id="trip-title">Loading...</div>
                        <div class="text-sm text-gray-400" id="trip-route"></div>
                    </div>
                </div>
                <div class="flex items-center gap-6">
                    <div class="grid grid-cols-3 gap-6 text-center">
                        <div>
                            <div class="text-2xl font-bold text-white" id="trip-distance">--</div>
                            <div class="text-xs text-gray-500">MILES</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-white" id="trip-time">--</div>
                            <div class="text-xs text-gray-500">EST. TIME</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-green-400" id="trip-status">--</div>
                            <div class="text-xs text-gray-500">STATUS</div>
                        </div>
                    </div>
                    <button onclick="shareUpdate('trip')" class="whatsapp-btn text-white p-3 rounded-full" title="Share trip update">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Today's Tasks -->
                <div class="glass rounded-xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üìã</span> Today's Tasks
                        </h2>
                        <span id="task-count" class="text-sm text-gray-500">0 tasks</span>
                    </div>
                    <div id="tasks-list" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">Loading tasks...</div>
                    </div>
                </div>

                <!-- Michael's Swim Meet -->
                <div class="glass rounded-xl p-5 border-l-4 border-blue-400">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üèä</span> Michael's Swim Meet
                        </h2>
                        <div class="flex items-center gap-2">
                            <span class="status-badge bg-blue-900 text-blue-300" id="meet-status">TODAY</span>
                            <button onclick="shareUpdate('swim')" class="whatsapp-btn text-white p-2 rounded-lg text-xs" title="Share">
                                üì± Share
                            </button>
                        </div>
                    </div>
                    <div id="swim-meet-details" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">Loading meet info...</div>
                    </div>
                </div>

                <!-- Driving Log -->
                <div class="glass rounded-xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üöó</span> Driving Log
                        </h2>
                        <span id="total-miles" class="text-sm text-gray-500">0 miles today</span>
                    </div>
                    <div id="driving-log" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">Loading trips...</div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Family Members -->
                <div class="glass rounded-xl p-5">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üë®‚Äçüë©‚Äçüë¶</span> Family Status
                    </h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-3 bg-purple-900/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üë§</div>
                                <div>
                                    <div class="font-medium">Ariel</div>
                                    <div class="text-xs text-gray-400" id="ariel-status">At Home</div>
                                </div>
                            </div>
                            <div class="text-green-400 text-sm" id="ariel-icon">üè†</div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-blue-900/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üèä</div>
                                <div>
                                    <div class="font-medium">Michael</div>
                                    <div class="text-xs text-gray-400" id="michael-status">At Home</div>
                                </div>
                            </div>
                            <div class="text-blue-400 text-sm" id="michael-icon">üè†</div>
                        </div>
                        <div class="flex items-center justify-between p-3 bg-green-900/30 rounded-lg">
                            <div class="flex items-center gap-3">
                                <div class="text-2xl">üë©</div>
                                <div>
                                    <div class="font-medium">Mariam</div>
                                    <div class="text-xs text-gray-400">Home - Satellite Beach</div>
                                </div>
                            </div>
                            <div class="text-green-400 text-sm">üè†</div>
                        </div>
                    </div>
                </div>

                <!-- Hotel Reservation -->
                <div class="glass rounded-xl p-5 border-l-4 border-orange-400">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span>üè®</span> Hotel Tonight
                        </h2>
                        <button onclick="shareUpdate('hotel')" class="whatsapp-btn text-white p-2 rounded-lg text-xs">
                            üì± Share
                        </button>
                    </div>
                    <div id="hotel-details">
                        <div class="text-center text-gray-500 py-4">Loading...</div>
                    </div>
                </div>

                <!-- Michael's Nutrition -->
                <div class="glass rounded-xl p-5 border-l-4 border-green-400">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>ü•ó</span> Michael's Nutrition
                    </h2>
                    <div id="nutrition-details">
                        <div class="text-center text-gray-500 py-4">Loading...</div>
                    </div>
                </div>

                <!-- Home Base -->
                <div class="glass rounded-xl p-5">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <span>üè†</span> Home Base
                    </h2>
                    <div class="text-sm">
                        <div class="text-gray-400">390 Roosevelt Ave</div>
                        <div class="text-white font-medium">Satellite Beach, FL 32937</div>
                        <div class="mt-3 flex items-center gap-2 text-xs text-gray-500">
                            <span>üå¥</span> Brevard County
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-purple-400" id="stat-tasks">0</div>
                <div class="text-xs text-gray-500 uppercase">Tasks Today</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-blue-400" id="stat-miles">0</div>
                <div class="text-xs text-gray-500 uppercase">Miles Today</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-green-400" id="stat-events">0</div>
                <div class="text-xs text-gray-500 uppercase">Events</div>
            </div>
            <div class="glass rounded-xl p-4 text-center">
                <div class="text-3xl font-bold text-orange-400" id="stat-focus">--</div>
                <div class="text-xs text-gray-500 uppercase">Focus Score</div>
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-gray-500 text-xs">
            <p>Life OS v2.1 ‚Ä¢ Created by Ariel Shapira ‚Ä¢ Auto-refreshes every 30s</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://mocerqjnksmhcjzxrewo.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2VycWpua3NtaGNqenhyZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MzI1MjYsImV4cCI6MjA4MDEwODUyNn0.ySFJIOngWWB0aqYra4PoGFuqcbdHOx1ZV6T9-klKQDw';
        
        const headers = {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json'
        };

        // Store data globally for sharing
        let currentData = {
            trip: null,
            swimMeet: null,
            hotel: null,
            tasks: []
        };

        // WhatsApp Share Functions
        function openShareModal() {
            document.getElementById('share-modal').classList.add('active');
        }

        function closeShareModal() {
            document.getElementById('share-modal').classList.remove('active');
        }

        function generateMessage(type) {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const dateStr = now.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            
            let msg = `üè† *Shapira Family Update*\nüìÖ ${dateStr} ‚Ä¢ ${timeStr}\n\n`;
            
            if (type === 'trip' && currentData.trip) {
                const t = currentData.trip;
                msg += `üöó *TRAVEL UPDATE*\n`;
                msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                msg += `üìç From: ${t.origin || 'Home'}\n`;
                msg += `üìç To: ${t.destination || 'Destination'}\n`;
                msg += `üõ£Ô∏è Distance: ${t.distance_miles || '?'} miles\n`;
                msg += `‚è±Ô∏è Est. Time: ${Math.floor((t.estimated_time_minutes || 0) / 60)}h ${(t.estimated_time_minutes || 0) % 60}m\n`;
                msg += `üë• Travelers: ${(t.travelers || []).join(', ')}\n`;
                msg += `üìä Status: ${(t.status || 'unknown').toUpperCase()}\n`;
                if (t.departure_time) msg += `üïê Departure: ${t.departure_time}\n`;
            }
            else if (type === 'swim' && currentData.swimMeet) {
                const s = currentData.swimMeet;
                msg += `üèä *MICHAEL'S SWIM MEET*\n`;
                msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                msg += `üèÜ ${s.meet_name || 'Swim Meet'}\n`;
                msg += `üìç ${s.location || 'TBD'}\n`;
                msg += `üè´ ${s.school || ''}\n\n`;
                msg += `*Events:*\n`;
                (s.events || []).forEach(e => {
                    msg += `  ‚Ä¢ ${e.event} (Seed: ${e.seed_time || 'NT'})\n`;
                });
                msg += `\n‚è∞ Warmup: ${s.warmup_time || 'TBD'}\n`;
                msg += `üçΩÔ∏è Diet: ${s.diet_today || 'Standard'}\n`;
            }
            else if (type === 'hotel' && currentData.hotel) {
                const h = currentData.hotel;
                msg += `üè® *HOTEL RESERVATION*\n`;
                msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
                msg += `üè® ${h.hotel_name || 'Hotel TBD'}\n`;
                msg += `üìç ${h.address || 'Address TBD'}\n`;
                msg += `üì• Check-in: ${h.check_in || 'TBD'}\n`;
                msg += `üì§ Check-out: ${h.check_out || 'TBD'}\n`;
                msg += `üë• Guests: ${(h.guests || []).join(', ')}\n`;
            }
            else if (type === 'full') {
                msg += `üìã *FULL STATUS UPDATE*\n`;
                msg += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                
                if (currentData.trip) {
                    msg += `üöó *Travel:* ${currentData.trip.origin} ‚Üí ${currentData.trip.destination}\n`;
                    msg += `   ${currentData.trip.distance_miles} mi ‚Ä¢ Depart: ${currentData.trip.departure_time || 'TBD'}\n\n`;
                }
                
                if (currentData.swimMeet) {
                    msg += `üèä *Swim Meet:* ${currentData.swimMeet.meet_name}\n`;
                    msg += `   üìç ${currentData.swimMeet.location}\n`;
                    msg += `   Events: ${(currentData.swimMeet.events || []).map(e => e.event).join(', ')}\n\n`;
                }
                
                if (currentData.hotel) {
                    msg += `üè® *Hotel:* ${currentData.hotel.hotel_name || 'TBD'}\n`;
                    msg += `   Check-in: ${currentData.hotel.check_in || 'TBD'}\n\n`;
                }
                
                msg += `üë®‚Äçüë©‚Äçüë¶ *Family:*\n`;
                msg += `   ‚Ä¢ Ariel & Michael: Traveling to Ocala\n`;
                msg += `   ‚Ä¢ Mariam: Home (Satellite Beach)\n`;
            }
            
            msg += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            msg += `_Sent from Life OS_`;
            
            return msg;
        }

        function shareUpdate(type) {
            const message = generateMessage(type);
            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encoded}`, '_blank');
            closeShareModal();
        }

        function shareToNumber() {
            const phone = document.getElementById('phone-number').value.replace(/\D/g, '');
            if (!phone) {
                alert('Please enter a phone number');
                return;
            }
            const message = generateMessage('full');
            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/${phone}?text=${encoded}`, '_blank');
            closeShareModal();
        }

        // Update time display
        function updateTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
            document.getElementById('current-time').textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateTime, 1000);
        updateTime();

        async function fetchData() {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/activities?platform=eq.life_os&order=start_time.desc`,
                    { headers }
                );
                const activities = await res.json();
                
                let totalMiles = 0;
                let taskCount = 0;
                let eventCount = 0;
                
                const tasks = [];
                const trips = [];
                let activeTrip = null;
                let swimMeet = null;
                let hotel = null;
                let nutrition = null;
                
                activities.forEach(a => {
                    try {
                        const data = JSON.parse(a.notes || '{}');
                        
                        if (a.activity_type === 'DRIVING') {
                            const trip = { ...a, ...data };
                            trips.push(trip);
                            totalMiles += data.distance_miles || 0;
                            if (data.status === 'in_progress' || data.status === 'scheduled') {
                                activeTrip = trip;
                                currentData.trip = trip;
                            }
                        }
                        else if (a.activity_type === 'TASK') {
                            tasks.push({ ...a, ...data });
                            taskCount++;
                        }
                        else if (a.activity_type === 'SWIM_MEET') {
                            swimMeet = { ...a, ...data };
                            currentData.swimMeet = swimMeet;
                            eventCount++;
                        }
                        else if (a.activity_type === 'HOTEL') {
                            hotel = { ...a, ...data };
                            currentData.hotel = hotel;
                        }
                        else if (a.activity_type === 'NUTRITION') {
                            nutrition = { ...a, ...data };
                        }
                    } catch(e) {}
                });
                
                currentData.tasks = tasks;
                
                // Update stats
                document.getElementById('stat-tasks').textContent = taskCount;
                document.getElementById('stat-miles').textContent = totalMiles;
                document.getElementById('stat-events').textContent = eventCount;
                document.getElementById('task-count').textContent = `${taskCount} tasks`;
                document.getElementById('total-miles').textContent = `${totalMiles} miles today`;
                
                // Update family status based on trip
                if (activeTrip && (activeTrip.status === 'in_progress' || activeTrip.status === 'scheduled')) {
                    document.getElementById('ariel-status').textContent = `Traveling to ${activeTrip.destination || 'Ocala'}`;
                    document.getElementById('ariel-icon').textContent = 'üöó';
                    document.getElementById('michael-status').textContent = `Swim Meet - ${activeTrip.destination || 'Ocala'}`;
                    document.getElementById('michael-icon').textContent = 'üèä';
                }
                
                // Render trip banner
                if (activeTrip) {
                    document.getElementById('trip-banner').classList.remove('hidden');
                    document.getElementById('trip-title').textContent = activeTrip.title || 'Active Trip';
                    document.getElementById('trip-route').textContent = `${activeTrip.origin || 'Origin'} ‚Üí ${activeTrip.destination || 'Destination'}`;
                    document.getElementById('trip-distance').textContent = activeTrip.distance_miles || '--';
                    const hours = Math.floor((activeTrip.estimated_time_minutes || 0) / 60);
                    const mins = (activeTrip.estimated_time_minutes || 0) % 60;
                    document.getElementById('trip-time').textContent = `${hours}h ${mins}m`;
                    document.getElementById('trip-status').textContent = (activeTrip.status || 'SCHEDULED').toUpperCase();
                    if (activeTrip.departure_time) {
                        document.getElementById('trip-route').textContent += ` ‚Ä¢ Depart: ${activeTrip.departure_time}`;
                    }
                }
                
                // Render tasks
                const tasksHtml = tasks.length > 0 ? tasks.map(t => {
                    const statusColors = {
                        'completed': 'bg-green-900/50 text-green-300',
                        'in_progress': 'bg-blue-900/50 text-blue-300',
                        'scheduled': 'bg-purple-900/50 text-purple-300',
                        'pending': 'bg-gray-700 text-gray-300'
                    };
                    const statusIcons = {
                        'completed': '‚úÖ',
                        'in_progress': 'üîÑ',
                        'scheduled': 'üìÖ',
                        'pending': '‚è≥'
                    };
                    return `
                        <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-xl">${statusIcons[t.status] || 'üìå'}</span>
                                <div>
                                    <div class="font-medium">${t.title || 'Task'}</div>
                                    <div class="text-xs text-gray-500">${t.description || ''}</div>
                                </div>
                            </div>
                            <span class="status-badge ${statusColors[t.status] || 'bg-gray-700 text-gray-300'}">${(t.status || 'pending').toUpperCase()}</span>
                        </div>
                    `;
                }).join('') : '<div class="text-center text-gray-500 py-4">No tasks for today</div>';
                document.getElementById('tasks-list').innerHTML = tasksHtml;
                
                // Render swim meet
                if (swimMeet) {
                    const events = swimMeet.events || [];
                    document.getElementById('swim-meet-details').innerHTML = `
                        <div class="mb-3">
                            <div class="text-lg font-semibold text-white">${swimMeet.meet_name || 'Swim Meet'}</div>
                            <div class="text-sm text-gray-400">üìç ${swimMeet.location || 'TBD'}</div>
                            <div class="text-sm text-gray-400">üè´ ${swimMeet.school || ''}</div>
                        </div>
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            ${events.map(e => `
                                <div class="bg-blue-900/30 rounded-lg p-2 text-center">
                                    <div class="font-semibold text-blue-300">${e.event}</div>
                                    <div class="text-xs text-gray-400">Seed: ${e.seed_time || 'NT'}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-400">üçΩÔ∏è ${swimMeet.diet_today || 'Standard'}</span>
                            <span class="text-gray-400">‚è∞ Warmup: ${swimMeet.warmup_time || 'TBD'}</span>
                        </div>
                    `;
                }
                
                // Render hotel
                if (hotel) {
                    document.getElementById('hotel-details').innerHTML = `
                        <div class="space-y-2">
                            <div class="font-semibold text-orange-300">${hotel.hotel_name || 'Hotel TBD'}</div>
                            <div class="text-sm text-gray-400">üìç ${hotel.address || 'Address TBD'}</div>
                            <div class="flex justify-between text-sm mt-3">
                                <div><span class="text-gray-500">Check-in:</span> <span class="text-white">${hotel.check_in || 'TBD'}</span></div>
                            </div>
                            <div class="flex justify-between text-sm">
                                <div><span class="text-gray-500">Check-out:</span> <span class="text-white">${hotel.check_out || 'TBD'}</span></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-2">üë• ${(hotel.guests || []).join(', ')}</div>
                        </div>
                    `;
                }
                
                // Render nutrition
                if (nutrition) {
                    document.getElementById('nutrition-details').innerHTML = `
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <span class="text-green-400 font-medium">${nutrition.diet_phase?.toUpperCase() || 'STANDARD'}</span>
                                <span class="text-xs text-gray-500">${nutrition.meal_type || ''}</span>
                            </div>
                            <div class="text-sm text-gray-400">${(nutrition.foods || []).join(', ')}</div>
                            <div class="grid grid-cols-3 gap-2 mt-3 text-center text-xs">
                                <div class="bg-gray-800 rounded p-2">
                                    <div class="text-white font-bold">${nutrition.total_calories || 0}</div>
                                    <div class="text-gray-500">Cal</div>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <div class="text-white font-bold">${nutrition.total_protein_g || 0}g</div>
                                    <div class="text-gray-500">Protein</div>
                                </div>
                                <div class="bg-gray-800 rounded p-2">
                                    <div class="text-white font-bold">${nutrition.total_carbs_g || 0}g</div>
                                    <div class="text-gray-500">Carbs</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Render driving log
                const drivingHtml = trips.length > 0 ? trips.map(t => `
                    <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">${t.status === 'in_progress' ? 'üöó' : t.status === 'scheduled' ? 'üìÖ' : '‚úÖ'}</span>
                            <div>
                                <div class="font-medium">${t.title || 'Trip'}</div>
                                <div class="text-xs text-gray-500">${t.departure_time ? 'Depart: ' + t.departure_time : ''}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-blue-400">${t.distance_miles || 0} mi</div>
                            <div class="text-xs text-gray-500">${Math.floor((t.estimated_time_minutes || 0) / 60)}h ${(t.estimated_time_minutes || 0) % 60}m</div>
                        </div>
                    </div>
                `).join('') : '<div class="text-center text-gray-500 py-4">No trips logged today</div>';
                document.getElementById('driving-log').innerHTML = drivingHtml;
                
            } catch(e) {
                console.error('Fetch error:', e);
            }
        }

        // Close modal on outside click
        document.getElementById('share-modal').addEventListener('click', function(e) {
            if (e.target === this) closeShareModal();
        });

        fetchData();
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
